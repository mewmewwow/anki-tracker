<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anki Â≠¶‰π†ËøΩË∏™</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 24px;
            color: #333;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .card h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #555;
        }

        textarea {
            width: 100%;
            height: 120px;
            padding: 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #4a9eff;
        }

        textarea::placeholder {
            color: #adb5bd;
        }

        .actions {
            margin-top: 14px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #4a9eff;
            color: #fff;
        }

        .btn-primary:hover {
            background: #3a8eef;
        }

        .btn-primary:disabled {
            background: #b8d4f8;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .btn-danger {
            background: #ff6b6b;
            color: #fff;
        }

        .btn-danger:hover {
            background: #ee5a5a;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .date-display {
            margin-left: auto;
            font-size: 14px;
            color: #868e96;
        }

        .date-picker {
            margin-left: auto;
            padding: 10px 14px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            color: #333;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .date-picker:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .preview {
            display: none;
            margin-top: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .preview.show {
            display: block;
        }

        .preview-title {
            font-size: 13px;
            color: #868e96;
            margin-bottom: 12px;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .preview-item {
            background: #fff;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #4a9eff;
        }

        .preview-item .label {
            font-size: 12px;
            color: #868e96;
            margin-bottom: 4px;
        }

        .preview-item .value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .preview-item .value.warning {
            color: #f59f00;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .stat-card .number {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }

        .stat-card .label {
            font-size: 13px;
            color: #868e96;
            margin-top: 4px;
        }

        .chart-container {
            position: relative;
            height: 280px;
            margin-bottom: 20px;
        }

        .chart-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .chart-tab {
            padding: 8px 16px;
            background: #e9ecef;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s;
        }

        .chart-tab:hover {
            background: #dee2e6;
        }

        .chart-tab.active {
            background: #4a9eff;
            color: #fff;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date {
            font-weight: 600;
            min-width: 100px;
        }

        .history-stats {
            flex: 1;
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #666;
        }

        .history-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .history-actions {
            display: flex;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #adb5bd;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .breakdown-bar {
            display: flex;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .breakdown-bar .segment {
            transition: width 0.3s;
        }

        .breakdown-legend {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }

        .breakdown-legend span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .breakdown-legend .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .export-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }

        @media (max-width: 640px) {
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .history-stats {
                flex-wrap: wrap;
                gap: 8px;
            }
        }

        /* ËÆ§ËØÅÁõ∏ÂÖ≥Ê†∑Âºè */
        .hidden {
            display: none !important;
        }

        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .auth-card {
            background: #fff;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
        }

        .auth-card h1 {
            text-align: center;
            margin-bottom: 8px;
            justify-content: center;
        }

        .auth-subtitle {
            text-align: center;
            color: #868e96;
            font-size: 14px;
            margin-bottom: 32px;
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f1f3f5;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            transition: all 0.2s;
        }

        .auth-tab:hover {
            background: #e9ecef;
        }

        .auth-tab.active {
            background: #4a9eff;
            color: #fff;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .auth-input:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .auth-input::placeholder {
            color: #adb5bd;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 24px 0;
            color: #adb5bd;
            font-size: 13px;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e9ecef;
        }

        .oauth-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .oauth-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            transition: all 0.2s;
        }

        .oauth-btn:hover {
            background: #f8f9fa;
            border-color: #dee2e6;
        }

        .oauth-btn svg {
            width: 20px;
            height: 20px;
        }

        .user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .user-header h1 {
            margin-bottom: 0;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-email {
            font-size: 13px;
            color: #868e96;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-logout {
            padding: 8px 16px;
            background: #f1f3f5;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #495057;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: #e9ecef;
        }

        .auth-error {
            color: #ff6b6b;
            font-size: 13px;
            text-align: center;
            padding: 8px;
            background: #fff5f5;
            border-radius: 6px;
        }

        .auth-loading {
            text-align: center;
            padding: 40px;
            color: #868e96;
        }
    </style>
</head>
<body>
    <!-- ËÆ§ËØÅÈ°µÈù¢ -->
    <div class="auth-container" id="authContainer">
        <div class="auth-card">
            <h1>üìä Anki Â≠¶‰π†ËøΩË∏™</h1>
            <p class="auth-subtitle">ËøΩË∏™‰Ω†ÁöÑÊØèÊó•Â≠¶‰π†ËøõÂ∫¶</p>

            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">ÁôªÂΩï</button>
                <button class="auth-tab" id="signupTab">Ê≥®ÂÜå</button>
            </div>

            <form class="auth-form" id="authForm">
                <input type="email" class="auth-input" id="authEmail" placeholder="ÈÇÆÁÆ±Âú∞ÂùÄ" required>
                <input type="password" class="auth-input" id="authPassword" placeholder="ÂØÜÁ†Å" required>
                <div class="auth-error hidden" id="authError"></div>
                <button type="submit" class="btn btn-primary" id="authSubmit" style="width:100%">ÁôªÂΩï</button>
            </form>

            <div class="auth-divider">Êàñ</div>

            <div class="oauth-buttons">
                <button class="oauth-btn" id="googleLogin">
                    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    ‰ΩøÁî® Google ÁôªÂΩï
                </button>
                <button class="oauth-btn" id="githubLogin">
                    <svg viewBox="0 0 24 24"><path fill="#333" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                    ‰ΩøÁî® GitHub ÁôªÂΩï
                </button>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÂ∫îÁî®ÔºàÁôªÂΩïÂêéÊòæÁ§∫Ôºâ -->
    <div class="container hidden" id="appContainer">
        <div class="user-header">
            <h1>üìä Anki Â≠¶‰π†ËøΩË∏™</h1>
            <div class="user-menu">
                <span class="user-email" id="userEmail"></span>
                <button class="btn-logout" id="logoutBtn">ÁôªÂá∫</button>
            </div>
        </div>

        <!-- ËæìÂÖ•Âå∫Âüü -->
        <div class="card">
            <h2>Á≤òË¥¥‰ªäÊó•Êï∞ÊçÆ</h2>
            <textarea id="inputText" placeholder="Á≤òË¥¥ Anki ÁªüËÆ°ÊñáÊú¨Ôºå‰æãÂ¶ÇÔºö&#10;‰ªäÂ§©Âú® 83.38 ÂàÜÂÜÖÂ≠¶‰π†‰∫Ü 328 Âº†Âç°ÁâáÔºàÂπ≥ÂùáÊØèÂº†Âç°Áâá 15.25 ÁßíÔºâ&#10;„ÄåÈáçÊù•„ÄçËÆ°Êï∞Ôºö 121 (36.89%)&#10;Â≠¶‰π†Ôºö182ÔºõÂ§ç‰π†Ôºö84ÔºõÈáçÊñ∞Â≠¶‰π†Ôºö62ÔºõÂ∑≤Á≠õÈÄâÔºö0"></textarea>
            <div class="actions">
                <button class="btn btn-primary" id="saveBtn" disabled>‰øùÂ≠òÂà∞ --</button>
                <button class="btn btn-secondary" id="clearBtn">Ê∏ÖÁ©∫</button>
                <input type="date" id="dateSelect" class="date-picker">
            </div>
            <div class="preview" id="preview">
                <div class="preview-title">üìã Ëß£ÊûêÈ¢ÑËßà</div>
                <div class="preview-grid" id="previewGrid"></div>
            </div>
        </div>

        <!-- ÁªüËÆ°Ê¶ÇËßà -->
        <div class="stats-row" id="statsRow">
            <div class="stat-card">
                <div class="number" id="totalDays">0</div>
                <div class="label">Á¥ØËÆ°Â§©Êï∞</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalCards">0</div>
                <div class="label">Á¥ØËÆ°Âç°Áâá</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalTime">0</div>
                <div class="label">Á¥ØËÆ°Êó∂Èïø(ÂàÜ)</div>
            </div>
            <div class="stat-card">
                <div class="number" id="avgRetry">0%</div>
                <div class="label">Âπ≥ÂùáÈáçÊù•Áéá</div>
            </div>
        </div>

        <!-- ÂõæË°®Âå∫Âüü -->
        <div class="card">
            <h2>üìà Ë∂ãÂäøÂõæË°®</h2>
            <div class="chart-tabs">
                <button class="chart-tab active" data-chart="cards">Âç°ÁâáÊï∞Èáè</button>
                <button class="chart-tab" data-chart="duration">Â≠¶‰π†Êó∂Èïø</button>
                <button class="chart-tab" data-chart="avgTime">Âπ≥ÂùáËÄóÊó∂</button>
                <button class="chart-tab" data-chart="retry">ÈáçÊù•ÊØî‰æã</button>
                <button class="chart-tab" data-chart="breakdown">Á±ªÂûãÂàÜÂ∏É</button>
            </div>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- ÂéÜÂè≤ËÆ∞ÂΩï -->
        <div class="card">
            <h2>üìã ÂéÜÂè≤ËÆ∞ÂΩï</h2>
            <div class="history-list" id="historyList">
                <div class="empty-state">ÊöÇÊó†Êï∞ÊçÆÔºåÁ≤òË¥¥‰Ω†ÁöÑÁ¨¨‰∏ÄÊù° Anki ÁªüËÆ°Âêß</div>
            </div>
            <div class="export-section">
                <button class="btn btn-secondary btn-small" id="exportBtn">ÂØºÂá∫ JSON</button>
                <button class="btn btn-secondary btn-small" id="importBtn">ÂØºÂÖ•Êï∞ÊçÆ</button>
                <input type="file" id="importFile" accept=".json" style="display:none">
            </div>
        </div>
    </div><!-- end appContainer -->

    <div class="toast" id="toast"></div>

    <script>
        // Supabase ÈÖçÁΩÆ
        const SUPABASE_URL = 'https://xoiigexoteorphfcexjx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvaWlnZXhvdGVvcnBoZmNleGp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyMDQ0NzYsImV4cCI6MjA4MTc4MDQ3Nn0.lGQlVM6Q8stDOybxGBSVHcpL_9CtuRl6QRbkn5ekfgI';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Êú¨Âú∞ÁºìÂ≠ò
        let dataCache = {};
        let currentUser = null;
        let isSignUpMode = false;
        let isDomReady = false;

        // ==================== ËÆ§ËØÅÁõ∏ÂÖ≥ÂáΩÊï∞ ====================

        // ÊòæÁ§∫ËÆ§ËØÅÈ°µÈù¢
        function showAuthForm() {
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }

        // ÊòæÁ§∫‰∏ªÂ∫îÁî®
        function showApp() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
        }

        // ÊòæÁ§∫ËÆ§ËØÅÈîôËØØ
        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        // ÈöêËóèËÆ§ËØÅÈîôËØØ
        function hideAuthError() {
            document.getElementById('authError').classList.add('hidden');
        }

        // ÈÇÆÁÆ±ÂØÜÁ†ÅÊ≥®ÂÜå
        async function signUp(email, password) {
            hideAuthError();
            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password
            });
            if (error) {
                showAuthError(error.message);
                return false;
            }
            if (data.user && !data.session) {
                showToast('Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑Êü•Êî∂È™åËØÅÈÇÆ‰ª∂');
            }
            return true;
        }

        // ÈÇÆÁÆ±ÂØÜÁ†ÅÁôªÂΩï
        async function signIn(email, password) {
            hideAuthError();
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            if (error) {
                showAuthError(error.message);
                return false;
            }
            return true;
        }

        // OAuth ÁôªÂΩï
        async function signInWithOAuth(provider) {
            hideAuthError();
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider,
                options: {
                    redirectTo: window.location.origin + window.location.pathname
                }
            });
            if (error) {
                showAuthError(error.message);
            }
        }

        // ÁôªÂá∫
        async function signOut() {
            await supabaseClient.auth.signOut();
            dataCache = {};
            currentUser = null;
        }

        // Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                currentUser = session.user;
                showApp();
                return true;
            } else {
                showAuthForm();
                return false;
            }
        }

        // ÂàùÂßãÂåñÂ∫îÁî®ÔºàÁôªÂΩïÂêéË∞ÉÁî®Ôºâ
        async function initApp() {
            if (!isDomReady || !currentUser) return;

            showApp();
            await loadData();
            updateStats();
            updateHistory();
            updateChart();
            showToast('Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
        }

        // ÁõëÂê¨ËÆ§ËØÅÁä∂ÊÄÅÂèòÂåñ
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth event:', event, session?.user?.email);

            if (session) {
                currentUser = session.user;
                // DOM ÂáÜÂ§áÂ•ΩÂêéÊâçÂàùÂßãÂåñÂ∫îÁî®
                if (isDomReady) {
                    await initApp();
                }
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                dataCache = {};
                if (isDomReady) {
                    showAuthForm();
                }
            }
        });

        // Ëé∑Âèñ‰ªäÂ§©Êó•Êúü
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }

        // Ê†ºÂºèÂåñÊó•ÊúüÊòæÁ§∫
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['Âë®Êó•', 'Âë®‰∏Ä', 'Âë®‰∫å', 'Âë®‰∏â', 'Âë®Âõõ', 'Âë®‰∫î', 'Âë®ÂÖ≠'];
            return `${month}Êúà${day}Êó• ${weekdays[date.getDay()]}`;
        }

        // Ëß£Êûê Anki ÁªüËÆ°ÊñáÊú¨
        function parseAnkiText(text) {
            try {
                const cleanText = text.replace(/[\u2068\u2069]/g, '');
                
                const durationMatch = cleanText.match(/Âú®\s*([\d.]+)\s*ÂàÜ/);
                const cardsMatch = cleanText.match(/Â≠¶‰π†‰∫Ü\s*([\d]+)\s*Âº†/);
                const avgMatch = cleanText.match(/Âπ≥ÂùáÊØèÂº†Âç°Áâá\s*([\d.]+)\s*Áßí/);
                const retryMatch = cleanText.match(/„ÄåÈáçÊù•„ÄçËÆ°Êï∞[Ôºö:]\s*([\d]+)\s*\(([\d.]+)%\)/);
                const learnMatch = cleanText.match(/Â≠¶‰π†[Ôºö:]\s*([\d]+)/);
                const reviewMatch = cleanText.match(/Â§ç‰π†[Ôºö:]\s*([\d]+)/);
                const relearnMatch = cleanText.match(/ÈáçÊñ∞Â≠¶‰π†[Ôºö:]\s*([\d]+)/);
                const filteredMatch = cleanText.match(/Â∑≤Á≠õÈÄâ[Ôºö:]\s*([\d]+)/);

                if (!durationMatch || !cardsMatch) {
                    return null;
                }

                return {
                    duration: parseFloat(durationMatch[1]),
                    cards: parseInt(cardsMatch[1]),
                    avgSeconds: avgMatch ? parseFloat(avgMatch[1]) : 0,
                    retryCount: retryMatch ? parseInt(retryMatch[1]) : 0,
                    retryPercent: retryMatch ? parseFloat(retryMatch[2]) : 0,
                    learn: learnMatch ? parseInt(learnMatch[1]) : 0,
                    review: reviewMatch ? parseInt(reviewMatch[1]) : 0,
                    relearn: relearnMatch ? parseInt(relearnMatch[1]) : 0,
                    filtered: filteredMatch ? parseInt(filteredMatch[1]) : 0
                };
            } catch (e) {
                console.error('Ëß£ÊûêÈîôËØØ:', e);
                return null;
            }
        }

        // ‰ªé Supabase Âä†ËΩΩÊï∞ÊçÆ
        async function loadData() {
            if (!currentUser) return {};

            try {
                const { data, error } = await supabaseClient
                    .from('anki_records')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date', { ascending: true });

                if (error) {
                    console.error('Supabase error:', JSON.stringify(error));
                    throw new Error(error.message || JSON.stringify(error));
                }

                dataCache = {};
                data.forEach(record => {
                    dataCache[record.date] = {
                        duration: record.duration,
                        cards: record.cards,
                        avgSeconds: record.avg_seconds,
                        retryCount: record.retry_count,
                        retryPercent: record.retry_percent,
                        learn: record.learn,
                        review: record.review,
                        relearn: record.relearn,
                        filtered: record.filtered
                    };
                });
                return dataCache;
            } catch (e) {
                console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', e.message || e);
                showToast('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•: ' + (e.message || 'Êú™Áü•ÈîôËØØ'));
                return {};
            }
        }

        // ‰øùÂ≠òÊï∞ÊçÆÂà∞ Supabase
        async function saveRecord(date, parsed) {
            if (!currentUser) return false;

            try {
                const record = {
                    date: date,
                    user_id: currentUser.id,
                    duration: parsed.duration,
                    cards: parsed.cards,
                    avg_seconds: parsed.avgSeconds,
                    retry_count: parsed.retryCount,
                    retry_percent: parsed.retryPercent,
                    learn: parsed.learn,
                    review: parsed.review,
                    relearn: parsed.relearn,
                    filtered: parsed.filtered
                };

                const { data, error } = await supabaseClient
                    .from('anki_records')
                    .upsert(record, { onConflict: 'user_id,date' })
                    .select();

                if (error) {
                    console.error('Supabase save error:', JSON.stringify(error));
                    throw new Error(error.message || JSON.stringify(error));
                }

                dataCache[date] = parsed;
                return true;
            } catch (e) {
                console.error('‰øùÂ≠òÂ§±Ë¥•:', e.message || e);
                showToast('‰øùÂ≠òÂ§±Ë¥•: ' + (e.message || 'Êú™Áü•ÈîôËØØ'));
                return false;
            }
        }

        // Âà†Èô§ËÆ∞ÂΩï
        async function deleteRecord(date) {
            if (!currentUser) return;
            if (!confirm(`Á°ÆÂÆöÂà†Èô§ ${formatDate(date)} ÁöÑËÆ∞ÂΩïÂêóÔºü`)) return;

            try {
                const { error } = await supabaseClient
                    .from('anki_records')
                    .delete()
                    .eq('user_id', currentUser.id)
                    .eq('date', date);

                if (error) {
                    console.error('Supabase delete error:', JSON.stringify(error));
                    throw new Error(error.message || JSON.stringify(error));
                }

                delete dataCache[date];
                updateStats();
                updateHistory();
                updateChart();
                showToast('Â∑≤Âà†Èô§');
            } catch (e) {
                console.error('Âà†Èô§Â§±Ë¥•:', e.message || e);
                showToast('Âà†Èô§Â§±Ë¥•: ' + (e.message || 'Êú™Áü•ÈîôËØØ'));
            }
        }

        // ÊòæÁ§∫ Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // Êõ¥Êñ∞È¢ÑËßà
        function updatePreview(parsed) {
            const preview = document.getElementById('preview');
            const grid = document.getElementById('previewGrid');
            const saveBtn = document.getElementById('saveBtn');

            if (!parsed) {
                preview.classList.remove('show');
                saveBtn.disabled = true;
                return;
            }

            preview.classList.add('show');
            saveBtn.disabled = false;

            grid.innerHTML = `
                <div class="preview-item">
                    <div class="label">Â≠¶‰π†Êó∂Èïø</div>
                    <div class="value">${parsed.duration} ÂàÜ</div>
                </div>
                <div class="preview-item">
                    <div class="label">Âç°ÁâáÊÄªÊï∞</div>
                    <div class="value">${parsed.cards} Âº†</div>
                </div>
                <div class="preview-item">
                    <div class="label">Âπ≥ÂùáÈÄüÂ∫¶</div>
                    <div class="value">${parsed.avgSeconds} Áßí/Âº†</div>
                </div>
                <div class="preview-item">
                    <div class="label">ÈáçÊù•ÊØî‰æã</div>
                    <div class="value ${parsed.retryPercent > 30 ? 'warning' : ''}">${parsed.retryPercent}%</div>
                </div>
                <div class="preview-item">
                    <div class="label">Â≠¶‰π†</div>
                    <div class="value">${parsed.learn}</div>
                </div>
                <div class="preview-item">
                    <div class="label">Â§ç‰π†</div>
                    <div class="value">${parsed.review}</div>
                </div>
                <div class="preview-item">
                    <div class="label">ÈáçÊñ∞Â≠¶‰π†</div>
                    <div class="value">${parsed.relearn}</div>
                </div>
                <div class="preview-item">
                    <div class="label">Â∑≤Á≠õÈÄâ</div>
                    <div class="value">${parsed.filtered}</div>
                </div>
            `;
        }

        // Êõ¥Êñ∞ÁªüËÆ°Ê¶ÇËßà
        function updateStats() {
            const entries = Object.values(dataCache);
            
            const totalDays = entries.length;
            const totalCards = entries.reduce((sum, e) => sum + e.cards, 0);
            const totalTime = entries.reduce((sum, e) => sum + e.duration, 0);
            const avgRetry = entries.length > 0 
                ? (entries.reduce((sum, e) => sum + e.retryPercent, 0) / entries.length).toFixed(1)
                : 0;

            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('totalCards').textContent = totalCards;
            document.getElementById('totalTime').textContent = totalTime.toFixed(0);
            document.getElementById('avgRetry').textContent = avgRetry + '%';
        }

        // Êõ¥Êñ∞ÂéÜÂè≤ËÆ∞ÂΩï
        function updateHistory() {
            const list = document.getElementById('historyList');
            const dates = Object.keys(dataCache).sort().reverse();

            if (dates.length === 0) {
                list.innerHTML = '<div class="empty-state">ÊöÇÊó†Êï∞ÊçÆÔºåÁ≤òË¥¥‰Ω†ÁöÑÁ¨¨‰∏ÄÊù° Anki ÁªüËÆ°Âêß</div>';
                return;
            }

            list.innerHTML = dates.map(date => {
                const d = dataCache[date];
                return `
                    <div class="history-item">
                        <div class="history-date">${formatDate(date)}</div>
                        <div class="history-stats">
                            <span>üÉè ${d.cards} Âº†</span>
                            <span>‚è±Ô∏è ${d.duration} ÂàÜ</span>
                            <span>üîÑ ${d.retryPercent}%</span>
                        </div>
                        <div class="history-actions">
                            <button class="btn btn-danger btn-small" onclick="deleteRecord('${date}')">Âà†Èô§</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ÂõæË°®Áõ∏ÂÖ≥
        let mainChart = null;
        let currentChartType = 'cards';

        function updateChart() {
            const dates = Object.keys(dataCache).sort().slice(-30);
            
            if (dates.length === 0) {
                if (mainChart) {
                    mainChart.destroy();
                    mainChart = null;
                }
                return;
            }

            const labels = dates.map(d => {
                const date = new Date(d);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });

            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (mainChart) {
                mainChart.destroy();
            }

            let chartConfig;

            if (currentChartType === 'cards') {
                chartConfig = {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Âç°ÁâáÊï∞Èáè',
                            data: dates.map(d => dataCache[d].cards),
                            borderColor: '#4a9eff',
                            backgroundColor: 'rgba(74, 158, 255, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    }
                };
            } else if (currentChartType === 'duration') {
                chartConfig = {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Â≠¶‰π†Êó∂Èïø(ÂàÜ)',
                            data: dates.map(d => dataCache[d].duration),
                            borderColor: '#51cf66',
                            backgroundColor: 'rgba(81, 207, 102, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    }
                };
            } else if (currentChartType === 'avgTime') {
                chartConfig = {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Âπ≥ÂùáËÄóÊó∂(Áßí/Âº†)',
                            data: dates.map(d => dataCache[d].avgSeconds),
                            borderColor: '#9775fa',
                            backgroundColor: 'rgba(151, 117, 250, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    }
                };
            } else if (currentChartType === 'retry') {
                chartConfig = {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'ÈáçÊù•ÊØî‰æã(%)',
                            data: dates.map(d => dataCache[d].retryPercent),
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            fill: true,
                            tension: 0.3
                        }]
                    }
                };
            } else if (currentChartType === 'breakdown') {
                chartConfig = {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: 'Â≠¶‰π†',
                                data: dates.map(d => dataCache[d].learn),
                                backgroundColor: '#4a9eff'
                            },
                            {
                                label: 'Â§ç‰π†',
                                data: dates.map(d => dataCache[d].review),
                                backgroundColor: '#51cf66'
                            },
                            {
                                label: 'ÈáçÊñ∞Â≠¶‰π†',
                                data: dates.map(d => dataCache[d].relearn),
                                backgroundColor: '#fcc419'
                            },
                            {
                                label: 'Â∑≤Á≠õÈÄâ',
                                data: dates.map(d => dataCache[d].filtered),
                                backgroundColor: '#868e96'
                            }
                        ]
                    },
                    options: {
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        }
                    }
                };
            }

            chartConfig.options = {
                ...chartConfig.options,
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: currentChartType === 'breakdown'
                    }
                }
            };

            mainChart = new Chart(ctx, chartConfig);
        }

        // ÂØºÂá∫Êï∞ÊçÆ
        function exportData() {
            const blob = new Blob([JSON.stringify(dataCache, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `anki-tracker-${getTodayDate()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Â∑≤ÂØºÂá∫');
        }

        // ÂØºÂÖ•Êï∞ÊçÆ
        async function importData(file) {
            try {
                const text = await file.text();
                const importedData = JSON.parse(text);
                
                let count = 0;
                for (const [date, record] of Object.entries(importedData)) {
                    await saveRecord(date, record);
                    count++;
                }
                
                await loadData();
                updateStats();
                updateHistory();
                updateChart();
                showToast(`Â∑≤ÂØºÂÖ• ${count} Êù°ËÆ∞ÂΩï`);
            } catch (e) {
                console.error('ÂØºÂÖ•Â§±Ë¥•:', e);
                showToast('ÂØºÂÖ•Â§±Ë¥•ÔºöÊó†ÊïàÁöÑ JSON Êñá‰ª∂');
            }
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            // ==================== ËÆ§ËØÅÁõ∏ÂÖ≥‰∫ã‰ª∂ÁªëÂÆö ====================

            // ÁôªÂΩï/Ê≥®ÂÜå Tab ÂàáÊç¢
            document.getElementById('loginTab').addEventListener('click', () => {
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('signupTab').classList.remove('active');
                document.getElementById('authSubmit').textContent = 'ÁôªÂΩï';
                isSignUpMode = false;
                hideAuthError();
            });

            document.getElementById('signupTab').addEventListener('click', () => {
                document.getElementById('signupTab').classList.add('active');
                document.getElementById('loginTab').classList.remove('active');
                document.getElementById('authSubmit').textContent = 'Ê≥®ÂÜå';
                isSignUpMode = true;
                hideAuthError();
            });

            // Ë°®ÂçïÊèê‰∫§
            document.getElementById('authForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                const submitBtn = document.getElementById('authSubmit');

                submitBtn.disabled = true;
                submitBtn.textContent = isSignUpMode ? 'Ê≥®ÂÜå‰∏≠...' : 'ÁôªÂΩï‰∏≠...';

                if (isSignUpMode) {
                    await signUp(email, password);
                } else {
                    await signIn(email, password);
                }

                submitBtn.disabled = false;
                submitBtn.textContent = isSignUpMode ? 'Ê≥®ÂÜå' : 'ÁôªÂΩï';
            });

            // OAuth ÁôªÂΩï
            document.getElementById('googleLogin').addEventListener('click', () => signInWithOAuth('google'));
            document.getElementById('githubLogin').addEventListener('click', () => signInWithOAuth('github'));

            // ÁôªÂá∫ÊåâÈíÆ
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                console.log('Logout clicked');
                await signOut();
            });

            // ==================== Ê†áËÆ∞ DOM Â∑≤ÂáÜÂ§áÂ•Ω ====================
            isDomReady = true;

            // ==================== Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ ====================
            // Â¶ÇÊûú onAuthStateChange Â∑≤ÁªèËÆæÁΩÆ‰∫Ü currentUserÔºåÁõ¥Êé•ÂàùÂßãÂåñ
            if (currentUser) {
                await initApp();
            } else {
                // Âê¶ÂàôÊ£ÄÊü• session
                const isLoggedIn = await checkAuth();
                if (isLoggedIn) {
                    await initApp();
                }
            }

            // ==================== ‰∏ªÂ∫îÁî®‰∫ã‰ª∂ÁªëÂÆö ====================

            // ÂàùÂßãÂåñÊó•ÊúüÈÄâÊã©Âô®
            const dateSelect = document.getElementById('dateSelect');
            const saveBtn = document.getElementById('saveBtn');
            dateSelect.value = getTodayDate();
            
            // Êõ¥Êñ∞ÊåâÈíÆÊñáÊ°à
            function updateSaveBtnText() {
                const selectedDate = dateSelect.value;
                if (selectedDate) {
                    saveBtn.textContent = `‰øùÂ≠òÂà∞ ${formatDate(selectedDate)}`;
                }
            }
            updateSaveBtnText();

            // Êó•ÊúüÈÄâÊã©ÂèòÂåñÊó∂Êõ¥Êñ∞ÊåâÈíÆ
            dateSelect.addEventListener('change', updateSaveBtnText);

            // ÁõëÂê¨ËæìÂÖ•
            const textarea = document.getElementById('inputText');
            textarea.addEventListener('input', () => {
                const parsed = parseAnkiText(textarea.value);
                updatePreview(parsed);
                if (parsed) {
                    updateSaveBtnText();
                }
            });

            // ‰øùÂ≠òÊåâÈíÆ
            document.getElementById('saveBtn').addEventListener('click', async () => {
                const parsed = parseAnkiText(textarea.value);
                if (!parsed) return;

                const selectedDate = dateSelect.value;
                
                if (dataCache[selectedDate]) {
                    if (!confirm(`${formatDate(selectedDate)} Â∑≤ÊúâËÆ∞ÂΩïÔºåÊòØÂê¶Ë¶ÜÁõñÔºü`)) return;
                }

                saveBtn.disabled = true;
                saveBtn.textContent = '‰øùÂ≠ò‰∏≠...';
                
                const success = await saveRecord(selectedDate, parsed);
                
                if (success) {
                    textarea.value = '';
                    updatePreview(null);
                    updateStats();
                    updateHistory();
                    updateChart();
                    showToast(`‚úì Â∑≤‰øùÂ≠òÂà∞ ${formatDate(selectedDate)}`);
                }
                
                updateSaveBtnText();
                saveBtn.disabled = false;
            });

            // Ê∏ÖÁ©∫ÊåâÈíÆ
            document.getElementById('clearBtn').addEventListener('click', () => {
                textarea.value = '';
                updatePreview(null);
            });

            // ÂõæË°®ÂàáÊç¢
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentChartType = tab.dataset.chart;
                    updateChart();
                });
            });

            // ÂØºÂá∫
            document.getElementById('exportBtn').addEventListener('click', exportData);

            // ÂØºÂÖ•
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('importFile').click();
            });

            document.getElementById('importFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importData(file);
                }
                e.target.value = '';
            });

        });
    </script>
</body>
</html>
